@page "/envelopes"
@rendermode InteractiveServer
@using Budget.Shared
@using Syncfusion.Blazor.Grids
@using Syncfusion.Blazor
@using Syncfusion.Blazor.DropDowns
@using Syncfusion.Blazor.Popups
@using Budget.Shared.Models
@using Budget.Shared.Services

<h1>Envelopes!</h1>
@if (_loading)
{
  <p><em>Loading envelopes...</em></p>
}
else if (!string.IsNullOrEmpty(_loadError))
{
  <div class="alert alert-danger">Failed to load: @_loadError</div>
}
else
{
  <div class="col-lg-12 control-section">
    <div class="content-wrapper" >
	    <div class="col-lg-8 control-section sb-property-border">
        <div class="control-wrapper">
          <label class="example-label">Choose Category</label>
          <SfDropDownList TItem="Cat" TValue="int?" PopupHeight="230px" Value="@SelectedCategoryId" ValueChanged="@CatChanged" DataSource="@Cats" >
            <DropDownListFieldSettings Text="CategoryName" Value="CategoryId" />
          </SfDropDownList>
        </div>
      </div>
      <p/>
      <div class="row">
	      <SfGrid TItem="EnvelopeResult" AllowEditing="false" DataSource="@SelectedEnvelopeData" AllowPaging="true" aria-label="Envelopes Table">
		      <GridSelectionSettings Mode="Syncfusion.Blazor.Grids.SelectionMode.Row" Type="SelectionType.Single"></GridSelectionSettings>
		      <GridEvents TValue="EnvelopeResult" RowSelected="RowSelectHandler" />
		      <GridColumns>
            <GridColumn HeaderText="" Width="50" TextAlign="TextAlign.Center" AllowEditing="false" AllowSorting="false">
              <Template>
                @if (context is EnvelopeResult er)
                {
                  <button type="button" class="btn btn-sm btn-outline-primary d-inline-flex align-items-center justify-content-center" style="width:30px;height:30px;" title="New Transaction" @onclick="() => NewTransaction(er.EnvelopeId)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true" focusable="false">
                      <path d="M8 1a.75.75 0 0 1 .75.75v5.5h5.5a.75.75 0 0 1 0 1.5h-5.5v5.5a.75.75 0 0 1-1.5 0v-5.5h-5.5a.75.75 0 0 1 0-1.5h5.5v-5.5A.75.75 0 0 1 8 1Z" />
                    </svg>
                    <span class="visually-hidden">New Transaction</span>
                  </button>
                }
              </Template>
            </GridColumn>
			      <GridColumn Field=@nameof(EnvelopeResult.CategoryName) HeaderText="Category" TextAlign="TextAlign.Left" Width="130" AllowEditing="false"></GridColumn>
			      <GridColumn Field=@nameof(EnvelopeResult.EnvelopeName) HeaderText="Envelope" TextAlign="TextAlign.Left" Width="120"></GridColumn>
			      <GridColumn Field=@nameof(EnvelopeResult.Balance) HeaderText="Balance" Width="60" Type="ColumnType.Decimal" TextAlign="TextAlign.Right"></GridColumn>
		      </GridColumns>
	      </SfGrid>
      </div>
      <div class="row mt-3">
	      <SfGrid TItem="TransactionDto" AllowEditing="false" DataSource="@TransactionData" AllowPaging="true" aria-label="Order Details Table">
		      <GridSelectionSettings Mode="Syncfusion.Blazor.Grids.SelectionMode.Row" Type="SelectionType.Single" ></GridSelectionSettings>
		      <GridEvents TValue="TransactionDto" OnRecordDoubleClick="RecordDoubleClickHandler" />
		      <GridColumns>
				  <GridColumn Field=@nameof(TransactionDto.LineId) HeaderText="Line#" Width="60" Type="ColumnType.Integer" TextAlign="TextAlign.Left"></GridColumn>
				  <GridColumn Field=@nameof(TransactionDto.Description) HeaderText="Description" Type="ColumnType.String" TextAlign="TextAlign.Left" Width="140"></GridColumn>
				  <GridColumn Field=@nameof(TransactionDto.Amount) HeaderText="Amount" Width="60" Type="ColumnType.Decimal" TextAlign="TextAlign.Right"></GridColumn>
		      </GridColumns>
	      </SfGrid>
      </div>
    </div>
  </div>
}

<ShowOneTransaction Transaction="@SelectedTransactionDetail" Visible="@ShowTransactionDialog" VisibleChanged="@OnShowTransactionDialogChanged" />

<PurchaseTransactionDialog Visible="@ShowPurchaseDialog"
                           VisibleChanged="OnPurchaseDialogVisibleChanged"
                           InitialEnvelopeId="@InitialEnvelopeIdForNew"
                           OnSaved="HandlePurchaseSaved"
                           OnCancelled="HandlePurchaseCancelled" />