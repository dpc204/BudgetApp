@using System.Globalization
@using MudBlazor
@using InputType = MudBlazor.InputType
@inject IBudgetApiClient BudgetApi
<MudDialog >
  <DialogContent>
    <MudForm @ref="_form" Model="_header">
      <MudGrid Class="mb-2">
        <MudItem xs="3" md="2">
          <MudPaper Outlined="true" Class="pa-3">
          <MudSelect T="int" @bind-Value="_header.AccountId" id="AccountSelect">
            @foreach (var e in Accounts)
            {
              <MudSelectItem Value="@e.Id">@e.Name</MudSelectItem>
            }
          </MudSelect>
          </MudPaper>
        </MudItem> 
        <MudPaper Outlined="true" Class="pa-3">
        <MudItem xs="12" md="5">
          <MudTextField @ref="_vendorField" T="string" @bind-Value="_header.Vendor" Label="Vendor" Required="true" Immediate="true" />
        </MudItem>
        </MudPaper>
        <MudItem xs="12" md="3">
          <MudDatePicker @bind-Date="HeaderDate" Label="Date" MaxDate="@DateTime.Today"/>
        </MudItem>
        <MudItem xs="12" md="2">
          <MudText Class="form-label mb-0 small text-muted">Total</MudText>
          <MudText Typo="Typo.subtitle2" Class="fw-bold">@_header.TotalAmount.ToString("C")</MudText>
        </MudItem>
        <MudItem xs="12" md="2" Class="text-end">
          @* Save button in footer *@
        </MudItem>
      </MudGrid>

      @* Show at most 5 visible data rows (dense mode) with a scrollable body instead of paging *@
      <MudTable Items="@_lines" Dense="true" Hover="true" Elevation="0" FixedHeader="true" Height="230px">
        <ToolBarContent>
        </ToolBarContent>
        <HeaderContent>
          <MudTh>Envelope</MudTh>
          <MudTh class="text-end">Amount</MudTh>
          <MudTh>Note</MudTh>
          <MudTh style="width:90px;"></MudTh>
        </HeaderContent>
        <RowTemplate>
          <MudTd>
            <MudSelect T="int" @bind-Value="context.EnvelopeId" Dense="true">
              @foreach (var e in Envelopes)
              {
                <MudSelectItem Value="@e.Id">@e.Name</MudSelectItem>
              }
            </MudSelect>
          </MudTd>
          <MudTd Class="text-end">
            <MudNumericField T="decimal"
                             @bind-Value="context.Amount"
                             For="@(() => context.Amount)"
                             @bind-Value:after="() => NormalizeAmount(context)"
                             Immediate="true"
                             Min="0.01m"
                             Format="N2"
                             Culture="@CultureInfo.CurrentCulture"
                             HideSpinButtons="true"
                             Validation="ValidateAmount"/>
            

            
          </MudTd>
          <MudTd>
            <MudTextField @bind-Value="context.Description" Immediate="true" Placeholder="Note (optional)"/>
          </MudTd>
          <MudTd Class="text-end">
            <MudIconButton Icon="@Icons.Material.Filled.Remove" Size="Size.Small" Variant="Variant.Outlined" Color="Color.Error"
                           OnClick="@(() => DeleteLine(context))" Disabled="@(_lines.Count <= 1)"/>
          </MudTd>
        </RowTemplate>
        <NoRecordsContent>
          <MudText Class="pa-2" Color="Color.Secondary">No line items. Click Add to begin.</MudText>
        </NoRecordsContent>
      </MudTable>
    </MudForm>
  </DialogContent>
  <DialogActions>
    <MudGrid Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
      <MudItem>
        <MudButton Size="Size.Small" Variant="Variant.Outlined" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="AddLine">Add Line</MudButton>
      </MudItem>
      <MudItem>
        <MudStack Row="true" Spacing="2">
          <MudButton Variant="Variant.Text" Color="Color.Secondary" OnClick="Cancel">Cancel</MudButton>
          <MudButton Variant="Variant.Filled" Color="Color.Primary" Disabled="@IsSaveDisabled" OnClick="Save">Save</MudButton>
        </MudStack>
      </MudItem>
    </MudGrid>
  </DialogActions>
</MudDialog>

<style>
  .purchase-dialog .e-dlg-content { padding-top: .75rem; }
  .purchase-dialog table td { vertical-align: middle; }
</style>