@using MudBlazor
@using InputType = MudBlazor.InputType
@inject IBudgetApiClient BudgetApi
<MudDialog >
  <DialogContent>
    <MudForm @ref="_form" Model="_header">
      <MudGrid Class="mb-2">
        <MudItem xs="12" md="5">
          <MudTextField @ref="_vendorField" T="string" @bind-Value="_header.Vendor" Label="Vendor" Required="true" Immediate="true"  />
        </MudItem>
        <MudItem xs="12" md="3">
          <MudDatePicker @bind-Date="HeaderDate" Label="Date" MaxDate="@DateTime.Today" />
        </MudItem>
        <MudItem xs="12" md="2">
          <MudText Class="form-label mb-0 small text-muted">Total</MudText>
          <MudText Typo="Typo.subtitle2" Class="fw-bold">@_header.TotalAmount.ToString("C")</MudText>
        </MudItem>
        <MudItem xs="12" md="2" Class="text-end">
          @* Save button in footer *@
        </MudItem>
      </MudGrid>

      <MudTable Items="@_lines" Dense="true" Hover="true" Elevation="0">
        <ToolBarContent>
          <MudButton Size="Size.Small" Variant="Variant.Outlined" Color="Color.Primary"
                     StartIcon="@Icons.Material.Filled.Add" OnClick="AddLine">Add Line</MudButton>
        </ToolBarContent>
        <HeaderContent>
          <MudTh>Envelope</MudTh>
          <MudTh class="text-end">Amount</MudTh>
          <MudTh>Note</MudTh>
          <MudTh style="width:90px;"></MudTh>
        </HeaderContent>
        <RowTemplate>
          <MudTd>
            <MudSelect T="int" @bind-Value="context.EnvelopeId"  Dense="true">
              @foreach (var e in Envelopes)
              {
                <MudSelectItem Value="@e.Id">@e.Name</MudSelectItem>
              }
            </MudSelect>
          </MudTd>
          <MudTd Class="text-end">
            <MudNumericField T="decimal"
                             @bind-Value="context.Amount"
                             For="@(() => context.Amount)"
                             @bind-Value:after="() => NormalizeAmount(context)"
                             Immediate="true"
                             Min="0.01m"
                             Format="C2"
                             HideSpinButtons="true"
                             Validation="ValidateAmount"
                 />
            
        

          </MudTd>
          <MudTd>
            <MudTextField @bind-Value="context.Description" Immediate="true" Placeholder="Note (optional)" />
          </MudTd>
          <MudTd Class="text-end">
            <MudIconButton Icon="@Icons.Material.Filled.Remove" Size="Size.Small" Variant="Variant.Outlined" Color="Color.Error"
                           OnClick="@(() => DeleteLine(context))" Disabled="@(_lines.Count <= 1)" />
          </MudTd>
        </RowTemplate>
        <NoRecordsContent>
          <MudText Class="pa-2" Color="Color.Secondary">No line items. Click Add to begin.</MudText>
        </NoRecordsContent>
      </MudTable>
    </MudForm>
  </DialogContent>
  <DialogActions>
    <MudButton Variant="Variant.Text" Color="Color.Secondary" OnClick="Cancel">Cancel</MudButton>
    <MudButton Variant="Variant.Filled" Color="Color.Primary" Disabled="@IsSaveDisabled" OnClick="SaveFromFooter">Save</MudButton>
  </DialogActions>
</MudDialog>

<style>
  .purchase-dialog .e-dlg-content { padding-top: .75rem; }
  .purchase-dialog table td { vertical-align: middle; }
</style>
