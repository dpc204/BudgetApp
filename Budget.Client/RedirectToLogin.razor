@inject NavigationManager NavigationManager

@code {
    private bool _navigated;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || _navigated)
            return;

        var currentUri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);

        // If we're already on any /Account page, do nothing to avoid loops
        if (currentUri.AbsolutePath.StartsWith("/Account", StringComparison.OrdinalIgnoreCase))
        {
            return;
        }

        _navigated = true;

        var returnUrl = Uri.EscapeDataString(NavigationManager.Uri);
        var loginUrl = $"/Account/Login?returnUrl={returnUrl}";

        // Navigate after the circuit is established to avoid prerender refresh loops
        NavigationManager.NavigateTo(loginUrl, forceLoad: true);
        await Task.CompletedTask;
    }
}